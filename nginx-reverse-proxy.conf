# ----------------------------------------
# Upstreams (internal Docker services)
# ----------------------------------------

# NestJS API server
upstream api_upstream {
  server server:8080;
}

# Admin panel (Vite, served by nginx inside "admin" container)
upstream admin_upstream {
  server admin:80;
}

# Public website (Next.js client)
upstream web_upstream {
  server web:3000;
}

# ----------------------------------------
# Main HTTP server (reverse proxy)
# ----------------------------------------
server {
  listen 80;
  server_name _;

  # Allow larger request bodies (file uploads, etc.)
  client_max_body_size 20m;

  # ----------------------------------------
  # /api/  -> NestJS server
  # ----------------------------------------
  location /api/ {
    proxy_pass http://api_upstream;

    proxy_http_version 1.1;
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;

    proxy_connect_timeout 60s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
  }

  # ----------------------------------------
  # /admin/  -> Admin app (Vite, behind nginx in "admin" container)
  #
  # IMPORTANT:
  #   Vite admin build should use: base: '/admin/'
  #   so assets load from /admin/assets/...
  # ----------------------------------------
  location /admin/ {
    proxy_pass http://admin_upstream;

    proxy_http_version 1.1;
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;

    # Optional WebSocket / HMR / SSE support
    proxy_set_header Upgrade            $http_upgrade;
    proxy_set_header Connection         "upgrade";

    proxy_connect_timeout 60s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
  }

  # ----------------------------------------
  # /  -> Public website (Next.js)
  # ----------------------------------------
  location / {
    proxy_pass http://web_upstream;

    proxy_http_version 1.1;
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;

    # Optional WebSocket / SSE support (Next.js can use this)
    proxy_set_header Upgrade            $http_upgrade;
    proxy_set_header Connection         "upgrade";

    proxy_connect_timeout 60s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
  }
}
